<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Arp_handler (arp.Arp_handler)</title><link rel="stylesheet" href="../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.2"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> â€“ <a href="../index.html">arp</a> &#x00BB; Arp_handler</nav><h1>Module <code>Arp_handler</code></h1><p>Protocol handler for the Address Resolution Protocol</p><p>This library provides a pure implementation of ARP, which handles only IPv4 addresses as protocol and Ethernet (MAC) addresses as hardware. This is the most common usage of ARP currently. There is no support for other types of addresses. ARP is initially specified in <a href="https://tools.ietf.org/html/rfc826">, RFC826</a>, and further refined in <a href="https://tools.ietf.org/html/rfc1122">, RFC1122</a> and partially <a href="https://tools.ietf.org/html/rfc5227">, RFC5227</a>.</p><p>The ARP handler consists of a cache, which maps IPv4 addresses to Ethernet addresses, and access to it. Its configuration is set during <a href="index.html#val-create"><span>construction</span></a>, together with the own IPv4 address and Ethernet address. The cache can be modified with <a href="index.html#val-static"><span>static</span></a> entries of other hosts, <a href="index.html#val-alias"><span>IPv4 aliases</span></a>, <a href="index.html#val-remove"><span>removal</span></a> of entries. Outgoing frames always use its <span class="xref-unresolved" title="unresolved reference to &quot;ip&quot;"><span>main IPv4 address</span></span>. Whether an entry <a href="index.html#val-in_cache"><span>is available</span></a> or not can be inspected.</p><p>The ARP handler can process <a href="index.html#val-input"><span>network input</span></a>, which may extend the cache with dynamic ARP entries which time out after the configured period. Periodic calls to <a href="index.html#val-tick"><code>tick</code></a> are required for the timeout and retry mechanisms. Since ARP usually uses network communication, callers may <a href="index.html#val-query"><code>query</code></a> the cache and wait until either a response was received or a timeout occured after several retries.</p><p>The embedded merge strategy is simple: static entries always win (and thus, both <a href="index.html#val-alias"><code>alias</code></a> and <a href="index.html#val-static"><code>static</code></a> overwrite existing entries). Log messages at the are generated if an ARP reply wants to overwrite a static entry, or the Ethernet address of a dynamic entry changed.</p><p>ARP frames which should be send on the wire are given as a pair of buffer and destination address, to be passed to the underlying layer (usually Ethernet). When adding entries, gratuitous ARP frames are to be sent.</p><p>While the <a href="../Arp_packet/index.html"><code>Arp_packet</code></a> module is exposed, for normal operation it is not needed, but this module should be sufficient.</p><p><em>v2.3.2 - <a href="https://github.com/mirage/arp">homepage</a></em></p><nav class="toc"><ul><li><a href="#constructor">Constructor</a></li><li><a href="#predicates">Predicates</a></li><li><a href="#operations-on-the-cache">Operations on the cache</a></li><li><a href="#events">Events</a></li></ul></nav></header><dl><dt class="spec type" id="type-t"><a href="#type-t" class="anchor"></a><code><span class="keyword">type</span> <span>'a t</span></code></dt><dd><p>The type of an ARP handler. It is polymorphic over the tasks waiting for an ARP reply.</p></dd></dl><section><header><h3 id="constructor"><a href="#constructor" class="anchor"></a>Constructor</h3></header><dl><dt class="spec value" id="val-create"><a href="#val-create" class="anchor"></a><code><span class="keyword">val</span> create : <span>?&#8288;timeout:int</span> <span>&#45;&gt;</span> <span>?&#8288;retries:int</span> <span>&#45;&gt;</span> <span>?&#8288;logsrc:Logs.src</span> <span>&#45;&gt;</span> <span>?&#8288;ipaddr:Ipaddr.V4.t</span> <span>&#45;&gt;</span> Macaddr.t <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> * <span><span>(<a href="../Arp_packet/index.html#type-t">Arp_packet.t</a> * Macaddr.t)</span> option</span></code></dt><dd><p><code>create ~timeout ~retries ~ipaddr mac)</code> is <code>t, garp</code>. The constructor of the ARP handler, specifying timeouts (defaults to 800) and amount of retries (defaults to 5). If <code>ipaddr</code> is provided, a gratuitous ARP request will be encoded in <code>garp</code>, otherwise <span class="xref-unresolved" title="unresolved reference to &quot;Ipaddr.V4.any&quot;"><span class="xref-unresolved" title="unresolved reference to &quot;Ipaddr.V4&quot;"><code>Ipaddr</code>.V4</span>.any</span> is temporarily used and <code>garp</code> is <code>None</code>. The value of <code>timeout</code> is the number of <code>Tick</code> events.</p><dl><dt>raises Invalid_argument</dt><dd><p>is <code>timeout</code> is 0 or negative or <code>retries</code> is negative.</p></dd></dl></dd></dl><dl><dt class="spec value" id="val-pp"><a href="#val-pp" class="anchor"></a><code><span class="keyword">val</span> pp : Stdlib.Format.formatter <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> unit</code></dt><dd><p><code>pp ppf t</code> prints the ARP handler <code>t</code> on <code>ppf</code> by iterating over all cache entries.</p></dd></dl></section><section><header><h3 id="predicates"><a href="#predicates" class="anchor"></a>Predicates</h3></header><dl><dt class="spec value" id="val-ips"><a href="#val-ips" class="anchor"></a><code><span class="keyword">val</span> ips : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <span>Ipaddr.V4.t list</span></code></dt><dd><p><code>ips t</code> is <code>ips</code>, the advertised IPv4 addresses.</p></dd></dl><dl><dt class="spec value" id="val-mac"><a href="#val-mac" class="anchor"></a><code><span class="keyword">val</span> mac : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> Macaddr.t</code></dt><dd><p><code>mac t</code> is <code>mac</code>, the mac address used by the ARP handler.</p></dd></dl><dl><dt class="spec value" id="val-in_cache"><a href="#val-in_cache" class="anchor"></a><code><span class="keyword">val</span> in_cache : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> Ipaddr.V4.t <span>&#45;&gt;</span> <span>Macaddr.t option</span></code></dt><dd><p><code>in_cache t ip</code> is <code>mac option</code>, a MAC address if the ARP cache contains an entry, <code>None</code> otherwise.</p></dd></dl></section><section><header><h3 id="operations-on-the-cache"><a href="#operations-on-the-cache" class="anchor"></a>Operations on the cache</h3></header><dl><dt class="spec value" id="val-static"><a href="#val-static" class="anchor"></a><code><span class="keyword">val</span> static : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> Ipaddr.V4.t <span>&#45;&gt;</span> Macaddr.t <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> * <span><span class="type-var">'a</span> option</span></code></dt><dd><p><code>static t ip mac</code> is <code>t', as</code>, where <code>t'</code> is <code>t</code> extended with a static ARP entry using the given <code>ip</code> and <code>mac</code>. The tasks waiting for <code>ip</code> are <code>as</code>.</p></dd></dl><dl><dt class="spec value" id="val-alias"><a href="#val-alias" class="anchor"></a><code><span class="keyword">val</span> alias : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> Ipaddr.V4.t <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> * <span>(<a href="../Arp_packet/index.html#type-t">Arp_packet.t</a> * Macaddr.t)</span> * <span><span class="type-var">'a</span> option</span></code></dt><dd><p><code>alias t ip</code> is <code>t', out, as</code>, where <code>t'</code> is <code>t</code> extended by a static ARP entry for <code>ip</code>. This entry will be used to answer further ARP requests. <code>out</code> is a gratuitous ARP frame. The tasks waiting for <code>ip</code> are <code>as</code>.</p></dd></dl><dl><dt class="spec value" id="val-remove"><a href="#val-remove" class="anchor"></a><code><span class="keyword">val</span> remove : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> Ipaddr.V4.t <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span></code></dt><dd><p><code>remove t ip</code> is <code>t'</code>, where <code>ip</code> is no longer in the cache.</p></dd></dl></section><section><header><h3 id="events"><a href="#events" class="anchor"></a>Events</h3></header><dl><dt class="spec value" id="val-tick"><a href="#val-tick" class="anchor"></a><code><span class="keyword">val</span> tick : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> * <span><span>(<a href="../Arp_packet/index.html#type-t">Arp_packet.t</a> * Macaddr.t)</span> list</span> * <span><span class="type-var">'a</span> list</span></code></dt><dd><p><code>tick t</code> is <code>t', requests, timeouts</code>, which advances the state <code>t</code> into <code>t'</code>. Possibly retransmissions of ARP requests need to be done, provided in the <code>requests</code> list. Timed out queries are in the <code>timeouts</code> list.</p></dd></dl><dl><dt class="spec value" id="val-input"><a href="#val-input" class="anchor"></a><code><span class="keyword">val</span> input : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> Cstruct.t <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> * <span><span>(<a href="../Arp_packet/index.html#type-t">Arp_packet.t</a> * Macaddr.t)</span> option</span> * <span><span>(Macaddr.t * <span class="type-var">'a</span>)</span> option</span></code></dt><dd><p><code>input t buf</code> is <code>t', reply, w</code>, which handles the input buffer <code>buf</code> in the state <code>t</code>. The state is transformed into <code>t'</code>. If it was an ARP request for one of our IPv4 addresses, an ARP reply should be send out <code>reply</code>. If the input was an awaited ARP reply, some elements <code>w</code> can be informed.</p></dd></dl><dl><dt class="spec type" id="type-qres"><a href="#type-qres" class="anchor"></a><code><span class="keyword">type</span> <span>'a qres</span></code><code> = </code><table class="variant"><tr id="type-qres.Mac" class="anchored"><td class="def constructor"><a href="#type-qres.Mac" class="anchor"></a><code>| </code><code><span class="constructor">Mac</span> <span class="keyword">of</span> Macaddr.t</code></td></tr><tr id="type-qres.Wait" class="anchored"><td class="def constructor"><a href="#type-qres.Wait" class="anchor"></a><code>| </code><code><span class="constructor">Wait</span> <span class="keyword">of</span> <span class="type-var">'a</span></code></td></tr><tr id="type-qres.RequestWait" class="anchored"><td class="def constructor"><a href="#type-qres.RequestWait" class="anchor"></a><code>| </code><code><span class="constructor">RequestWait</span> <span class="keyword">of</span> <a href="../Arp_packet/index.html#type-t">Arp_packet.t</a> * Macaddr.t * <span class="type-var">'a</span></code></td></tr></table></dt><dd><p>The type returned by query, either a <code>Mac</code> and a mac address, or <code>Wait</code> for a reply, or <code>RequestWait</code>, consisting of an ARP request to be send on the wire, and await its answer.</p></dd></dl><dl><dt class="spec value" id="val-query"><a href="#val-query" class="anchor"></a><code><span class="keyword">val</span> query : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> Ipaddr.V4.t <span>&#45;&gt;</span> <span>(<span><span class="type-var">'a</span> option</span> <span>&#45;&gt;</span> <span class="type-var">'a</span>)</span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> * <span><span class="type-var">'a</span> <a href="index.html#type-qres">qres</a></span></code></dt><dd><p><code>query t ip merge</code> is <code>t', qres</code>, which looks for the <code>ip</code> in the cache. If it is found, its value is <code>Mac mac</code>. If the <code>ip</code> is not in the cache, either some <code>'a</code> is waiting for it already, then the value is <code>Wait a</code>, where <code>a</code> is produced by applying <code>merge (Some 'a)</code> to the waiting thing. Otherwise, both an ARP request needs to be send out, and the value of <code>merge None</code> is put into the cache, both as part of <code>RequestWait</code>.</p></dd></dl></section></div></body></html>
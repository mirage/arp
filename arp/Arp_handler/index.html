<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Arp_handler (arp.Arp_handler)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../odoc.support/odoc.css"/><meta name="generator" content="odoc 3.1.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">Index</a> &#x00BB; <a href="../index.html">arp</a> &#x00BB; Arp_handler</nav><header class="odoc-preamble"><h1>Module <code><span>Arp_handler</span></code></h1><p>Protocol handler for the Address Resolution Protocol</p><p>This library provides a pure implementation of ARP, which handles only IPv4 addresses as protocol and Ethernet (MAC) addresses as hardware. This is the most common usage of ARP currently. There is no support for other types of addresses. ARP is initially specified in <a href="https://tools.ietf.org/html/rfc826">, RFC826</a>, and further refined in <a href="https://tools.ietf.org/html/rfc1122">, RFC1122</a> and partially <a href="https://tools.ietf.org/html/rfc5227">, RFC5227</a>.</p><p>The ARP handler consists of a cache, which maps IPv4 addresses to Ethernet addresses, and access to it. Its configuration is set during <a href="#val-create" title="create">construction</a>, together with the own IPv4 address and Ethernet address. The cache can be modified with <a href="#val-static" title="static">static</a> entries of other hosts, <a href="#val-alias" title="alias">IPv4 aliases</a>, <a href="#val-remove" title="remove">removal</a> of entries. Outgoing frames always use its <span class="xref-unresolved" title="ip">main IPv4 address</span>. Whether an entry <a href="#val-in_cache" title="in_cache">is available</a> or not can be inspected.</p><p>The ARP handler can process <a href="#val-input" title="input">network input</a>, which may extend the cache with dynamic ARP entries which time out after the configured period. Periodic calls to <a href="#val-tick"><code>tick</code></a> are required for the timeout and retry mechanisms. Since ARP usually uses network communication, callers may <a href="#val-query"><code>query</code></a> the cache and wait until either a response was received or a timeout occured after several retries.</p><p>The embedded merge strategy is simple: static entries always win (and thus, both <a href="#val-alias"><code>alias</code></a> and <a href="#val-static"><code>static</code></a> overwrite existing entries). Log messages at the are generated if an ARP reply wants to overwrite a static entry, or the Ethernet address of a dynamic entry changed.</p><p>ARP frames which should be send on the wire are given as a pair of buffer and destination address, to be passed to the underlying layer (usually Ethernet). When adding entries, gratuitous ARP frames are to be sent.</p><p>While the <a href="../Arp_packet/index.html"><code>Arp_packet</code></a> module is exposed, for normal operation it is not needed, but this module should be sufficient.</p><p><em>v4.1.0 - <a href="https://github.com/mirage/arp">homepage</a></em></p></header><div class="odoc-tocs"><nav class="odoc-toc odoc-local-toc"><ul><li><a href="#constructor">Constructor</a></li><li><a href="#predicates">Predicates</a></li><li><a href="#operations-on-the-cache">Operations on the cache</a></li><li><a href="#events">Events</a></li></ul></nav></div><div class="odoc-content"><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a t</span></span></code></div><div class="spec-doc"><p>The type of an ARP handler. It is polymorphic over the tasks waiting for an ARP reply.</p></div></div><h3 id="constructor"><a href="#constructor" class="anchor"></a>Constructor</h3><div class="odoc-spec"><div class="spec value anchored" id="val-create"><a href="#val-create" class="anchor"></a><code><span><span class="keyword">val</span> create : 
  <span><span class="optlabel">?cache_size</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?timeout</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?retries</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?logsrc</span>:<span class="xref-unresolved">Logs</span>.src <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?ipaddr</span>:<span class="xref-unresolved">Ipaddr</span>.V4.t <span class="arrow">&#45;&gt;</span></span>
  <span><span class="xref-unresolved">Macaddr</span>.t <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'a</span> <a href="#type-t">t</a></span> * <span><span>(<a href="../Arp_packet/index.html#type-t">Arp_packet.t</a> * <span class="xref-unresolved">Macaddr</span>.t)</span> option</span></span></code></div><div class="spec-doc"><p><code>create ~cache_size ~timeout ~retries ~ipaddr mac)</code> is <code>t, garp</code>. The constructor of the ARP handler, specifying timeouts (defaults to 800) and amount of retries (defaults to 5). If <code>ipaddr</code> is provided, a gratuitous ARP request will be encoded in <code>garp</code>, otherwise <code>Ipaddr.V4.any</code> is temporarily used and <code>garp</code> is <code>None</code>. The value of <code>timeout</code> is the number of <code>Tick</code> events. <code>cache_size</code> limits the number of dynamic entries in the ARP cache.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <code>Invalid_argument</code> <p>is <code>timeout</code> is 0 or negative or <code>retries</code> is negative.</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pp"><a href="#val-pp" class="anchor"></a><code><span><span class="keyword">val</span> pp : <span><span class="xref-unresolved">Stdlib</span>.Format.formatter <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>pp ppf t</code> prints the ARP handler <code>t</code> on <code>ppf</code> by iterating over all cache entries.</p></div></div><h3 id="predicates"><a href="#predicates" class="anchor"></a>Predicates</h3><div class="odoc-spec"><div class="spec value anchored" id="val-ips"><a href="#val-ips" class="anchor"></a><code><span><span class="keyword">val</span> ips : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="xref-unresolved">Ipaddr</span>.V4.t list</span></span></code></div><div class="spec-doc"><p><code>ips t</code> is <code>ips</code>, the advertised IPv4 addresses.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-mac"><a href="#val-mac" class="anchor"></a><code><span><span class="keyword">val</span> mac : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Macaddr</span>.t</span></code></div><div class="spec-doc"><p><code>mac t</code> is <code>mac</code>, the mac address used by the ARP handler.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-in_cache"><a href="#val-in_cache" class="anchor"></a><code><span><span class="keyword">val</span> in_cache : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="xref-unresolved">Ipaddr</span>.V4.t <span class="arrow">&#45;&gt;</span></span> <span><span class="xref-unresolved">Macaddr</span>.t option</span></span></code></div><div class="spec-doc"><p><code>in_cache t ip</code> is <code>mac option</code>, a MAC address if the ARP cache contains an entry, <code>None</code> otherwise.</p></div></div><h3 id="operations-on-the-cache"><a href="#operations-on-the-cache" class="anchor"></a>Operations on the cache</h3><div class="odoc-spec"><div class="spec value anchored" id="val-static"><a href="#val-static" class="anchor"></a><code><span><span class="keyword">val</span> static : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="xref-unresolved">Ipaddr</span>.V4.t <span class="arrow">&#45;&gt;</span></span> <span><span class="xref-unresolved">Macaddr</span>.t <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-t">t</a></span> * <span><span class="type-var">'a</span> option</span></span></code></div><div class="spec-doc"><p><code>static t ip mac</code> is <code>t', as</code>, where <code>t'</code> is <code>t</code> extended with a static ARP entry using the given <code>ip</code> and <code>mac</code>. The tasks waiting for <code>ip</code> are <code>as</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-alias"><a href="#val-alias" class="anchor"></a><code><span><span class="keyword">val</span> alias : 
  <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="xref-unresolved">Ipaddr</span>.V4.t <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'a</span> <a href="#type-t">t</a></span> * <span>(<a href="../Arp_packet/index.html#type-t">Arp_packet.t</a> * <span class="xref-unresolved">Macaddr</span>.t)</span> * <span><span class="type-var">'a</span> option</span></span></code></div><div class="spec-doc"><p><code>alias t ip</code> is <code>t', out, as</code>, where <code>t'</code> is <code>t</code> extended by a static ARP entry for <code>ip</code>. This entry will be used to answer further ARP requests. <code>out</code> is a gratuitous ARP frame. The tasks waiting for <code>ip</code> are <code>as</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-remove"><a href="#val-remove" class="anchor"></a><code><span><span class="keyword">val</span> remove : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="xref-unresolved">Ipaddr</span>.V4.t <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>remove t ip</code> is <code>t'</code>, where <code>ip</code> is no longer in the cache.</p></div></div><h3 id="events"><a href="#events" class="anchor"></a>Events</h3><div class="odoc-spec"><div class="spec value anchored" id="val-tick"><a href="#val-tick" class="anchor"></a><code><span><span class="keyword">val</span> tick : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-t">t</a></span> * <span><span>(<a href="../Arp_packet/index.html#type-t">Arp_packet.t</a> * <span class="xref-unresolved">Macaddr</span>.t)</span> list</span> * <span><span class="type-var">'a</span> list</span></span></code></div><div class="spec-doc"><p><code>tick t</code> is <code>t', requests, timeouts</code>, which advances the state <code>t</code> into <code>t'</code>. Possibly retransmissions of ARP requests need to be done, provided in the <code>requests</code> list. Timed out queries are in the <code>timeouts</code> list.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-input"><a href="#val-input" class="anchor"></a><code><span><span class="keyword">val</span> input : 
  <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="xref-unresolved">Cstruct</span>.t <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'a</span> <a href="#type-t">t</a></span> * <span><span>(<a href="../Arp_packet/index.html#type-t">Arp_packet.t</a> * <span class="xref-unresolved">Macaddr</span>.t)</span> option</span> * <span><span>(<span class="xref-unresolved">Macaddr</span>.t * <span class="type-var">'a</span>)</span> option</span></span></code></div><div class="spec-doc"><p><code>input t buf</code> is <code>t', reply, w</code>, which handles the input buffer <code>buf</code> in the state <code>t</code>. The state is transformed into <code>t'</code>. If it was an ARP request for one of our IPv4 addresses, an ARP reply should be send out <code>reply</code>. If the input was an awaited ARP reply, some elements <code>w</code> can be informed.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-qres"><a href="#type-qres" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a qres</span></span><span> = </span></code><ol><li id="type-qres.Mac" class="def variant constructor anchored"><a href="#type-qres.Mac" class="anchor"></a><code><span>| </span><span><span class="constructor">Mac</span> <span class="keyword">of</span> <span class="xref-unresolved">Macaddr</span>.t</span></code></li><li id="type-qres.Wait" class="def variant constructor anchored"><a href="#type-qres.Wait" class="anchor"></a><code><span>| </span><span><span class="constructor">Wait</span> <span class="keyword">of</span> <span class="type-var">'a</span></span></code></li><li id="type-qres.RequestWait" class="def variant constructor anchored"><a href="#type-qres.RequestWait" class="anchor"></a><code><span>| </span><span><span class="constructor">RequestWait</span> <span class="keyword">of</span> <a href="../Arp_packet/index.html#type-t">Arp_packet.t</a> * <span class="xref-unresolved">Macaddr</span>.t * <span class="type-var">'a</span></span></code></li></ol></div><div class="spec-doc"><p>The type returned by query, either a <code>Mac</code> and a mac address, or <code>Wait</code> for a reply, or <code>RequestWait</code>, consisting of an ARP request to be send on the wire, and await its answer.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-query"><a href="#val-query" class="anchor"></a><code><span><span class="keyword">val</span> query : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="xref-unresolved">Ipaddr</span>.V4.t <span class="arrow">&#45;&gt;</span></span> <span><span>(<span><span><span class="type-var">'a</span> option</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-t">t</a></span> * <span><span class="type-var">'a</span> <a href="#type-qres">qres</a></span></span></code></div><div class="spec-doc"><p><code>query t ip merge</code> is <code>t', qres</code>, which looks for the <code>ip</code> in the cache. If it is found, its value is <code>Mac mac</code>. If the <code>ip</code> is not in the cache, either some <code>'a</code> is waiting for it already, then the value is <code>Wait a</code>, where <code>a</code> is produced by applying <code>merge (Some 'a)</code> to the waiting thing. Otherwise, both an ARP request needs to be send out, and the value of <code>merge None</code> is put into the cache, both as part of <code>RequestWait</code>.</p></div></div></div></body></html>
